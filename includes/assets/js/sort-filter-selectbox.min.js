var mg;jQuery(document).ready(function($){$=jQuery;var $col_zone=$('.active-drop[data-areaid="directory_table-columns"]'),self={active_columns:[],directoryCol_zone:$col_zone,sort_box_name:"sort_field_key"};mg=self,self.init=function(){self.getColumns(self.directoryCol_zone),self.updateSortBoxes(),self.bindEvents()},self.bindEvents=function(){var sort_area=$("#directory-fields").find(".active-drop-field").data("uiSortable"),widget=sort_area.widget("ui-sortable");$('.gv-add-field.button-secondary[data-areaid="directory_table-columns"]').on("click",function(){$(".gv-fields").on("click",function(e){$(document).one("ajaxSuccess",function(event,xhr,settings){"ajaxSuccess"==event.type&&(self.addColumn(e.currentTarget),self.updateSortBoxes())})})}),$('.gv-field-controls a[href="#remove"]').on("click",function(e){self.removeColumn(e),self.updateSortBoxes()}),widget.on("sortupdate",function(event,ui){var selector="[name='"+self.sort_box_name+"']",$boxes=$(selector);$.each($boxes,function(box_index,box_value){$(this).empty()});var $col_zone=$('.active-drop[data-areaid="directory_table-columns"]');self.active_columns=[],self.getColumns($col_zone),self.updateSortBoxes(),self.bindEvents()})},self.getColumns=function(column_zone){var $fields=$(column_zone).find(".gv-fields");return $.each($fields,function(){self.theColumns(this)}),self.active_columns},self.addColumn=function(e){for(var field_id=e.getAttribute("data-fieldid"),$all_fields_with_ID=$("[data-areaid='directory_table-columns'] *[data-fieldid='"+field_id+"']"),i=0,count=$all_fields_with_ID.length;i<count;i++)if(i===count-1){var uuid=$all_fields_with_ID[i];uuid=$(uuid).find(".field-key").prop("name"),uuid=uuid.replace("fields[directory_table-columns][",""),uuid=uuid.replace("][id]","")}var label=document.getElementById("fieldsdirectory_table-columns"+uuid+"custom_label");if(label="undefined"!=typeof label.value&&label.value&&""!==label.value?label.value:$('.gv-fields[data-fieldid="'+field_id+'"]').find(".field-label").val(),"custom"===field_id){if("undefined"!=typeof gvDTIndex.index_custom_content&&0==gvDTIndex.index_custom_content)return self.active_columns;var j=0,new_field_id=field_id+"_"+j;for(var key in self.active_columns)new_field_id===self.active_columns[key].id&&(j++,new_field_id=field_id+"_"+j);0===Object.keys(self.active_columns).length?field_id+="_0":field_id=new_field_id}return self.active_columns[uuid]={id:field_id,label:label},uuid},self.theColumns=function(e){var field_id=e.getAttribute("data-fieldid"),$uuid=$(e).find(".field-key").attr("name"),$uuid=$uuid.replace("fields[directory_table-columns][",""),$uuid=$uuid.replace("][id]",""),label=document.getElementById("fieldsdirectory_table-columns"+$uuid+"custom_label"),label="undefined"==typeof label.value||""==label.value?$(e).find(".field-label").val():label.value;if("custom"===field_id){if("undefined"!=typeof gvDTIndex.index_custom_content&&0==gvDTIndex.index_custom_content)return console.log(gvDTIndex.index_custom_content),self.active_columns;var i=0,new_field_id=field_id+"_"+i;for(var key in self.active_columns)new_field_id===self.active_columns[key].id&&(i++,new_field_id=field_id+"_"+i);0===Object.keys(self.active_columns).length?field_id+="_0":field_id=new_field_id}return self.active_columns[$uuid]={id:field_id,label:label},self.active_columns},self.removeColumn=function(e){var $parent=$(e.target).parents(".gv-fields"),uuid=$parent.find(".field-key").prop("name"),uuid=uuid.replace("fields[directory_table-columns][",""),uuid=uuid.replace("][id]","");return delete self.active_columns[uuid],uuid},self.updateSortBoxes=function(){var selector="[name='"+self.sort_box_name+"']",$boxes=$(selector);window.dynamicFieldMap="undefined"!=typeof dynamicFieldMap?dynamicFieldMap:{},$.each($boxes,function(box_index,box_value){$(box_value).empty();for(var col_hash in self.active_columns)if("undefined"!=typeof window.dynamicFieldMap.data&&window.dynamicFieldMap.data.length>0){var selected=$.grep(window.dynamicFieldMap.data,function(el,index){return el.key===self.active_columns[col_hash].id&&box_index==index});0<selected.length?$(box_value).append("<option value='"+self.active_columns[col_hash].id+"' selected>"+self.active_columns[col_hash].label+"</option>"):$(box_value).append("<option value='"+self.active_columns[col_hash].id+"'>"+self.active_columns[col_hash].label+"</option>")}})},self.init()});